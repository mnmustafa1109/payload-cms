services:
  # --------------------------------------------------------------------------
  # 1. PostgreSQL Database Service
  # --------------------------------------------------------------------------
  postgres:
    image: postgres:alpine
    restart: always
    environment:
      # These variables define the credentials for the database,
      # which are referenced in the POSTGRES_URL below.
      POSTGRES_USER: payloaduser
      POSTGRES_PASSWORD: 7EcPCmsESEP07dO0N1umZlUIkuDc7wkx
      POSTGRES_DB: payload-db
    volumes:
      # This volume ensures your database data persists even if the container is stopped or removed.
      - postgres_data:/var/lib/postgresql
  payload:
    build: . # Builds the image using the Dockerfile in the current directory
    restart: always
    depends_on:
      - postgres # Ensures the database container starts before the application container
    ports:
      # Maps the host port 53000 to the internal container port 3000 (where Payload runs)
      - "53000:3000"
    environment:
      # Connection string uses the internal service name 'postgres' and the credentials defined above.
      DATABASE_URI: postgres://payloaduser:7EcPCmsESEP07dO0N1umZlUIkuDc7wkx@postgres:5432/payload-db
      PAYLOAD_SECRET: U8ABKYMRlO2NP6USUhOrucjfnptRVqOPMx8BsNlThu9
      PAYLOAD_PUBLIC_SERVER_URL: https://payload.lyoko.studio:443
      SEED_DB: "true" # Must be a string in YAML environments
      S3_ENDPOINT: https://minio.lyoko.studio
      S3_REGION: us-east-1
      S3_ACCESS_KEY_ID: payload
      S3_SECRET_ACCESS_KEY: xtSq0EVBP1FONNxQwOhW2TgaZPT83gybLo65vWh7dVb
      S3_BUCKET: payload-cms
      NODE_TLS_REJECT_UNAUTHORIZED: "1"
      SMTP_HOST: mail.lyoko.studio
      SMTP_USER: contact@lyoko.studio
      SMTP_PASS: "68,bMeLoW,{"
    # Optional: If you need access to local Payload files (e.g., config changes)
    # volumes:
    #   - ./src:/home/node/app/src

volumes:
  # Named volume for persistent storage of PostgreSQL data
  postgres_data:
